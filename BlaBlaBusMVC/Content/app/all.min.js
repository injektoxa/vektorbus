"use strict";angular.module("VektorApp",["ngAnimate","ngRoute","ui.bootstrap","core","pdfMaker","clientDetail","clientList","clientTripList","tripList","busList","modalBus","driverList","driverCrud","citiesList","agentList","modalAgent","modalClient","reports","signUp","signIn","LocalStorageModule","navBar","manageAccount","googleMaps"]),angular.module("VektorApp").constant("authConstants",{ClientAccessRoles:["Driver"],BussesAccessRoles:["Driver","Partner"],AllRoles:["User","Driver","Partner"]}).config(["$locationProvider","$routeProvider","authConstants","$httpProvider","$qProvider",function(e,t,n,r,a){r.interceptors.push("authInterceptorService"),r.defaults.useXDomain=!0,delete r.defaults.headers.common["X-Requested-With"],e.html5Mode(!0),a.errorOnUnhandledRejections(!1),t.when("/clients",{template:"<client-list></client-list>",acceptedRoles:n.ClientAccessRoles}).when("/clients/:clientId",{template:"<client-detail></client-detail>"}).when("/trips",{template:"<trip-list></trip-list>",acceptedRoles:n.AllRoles}).when("/buses",{template:"<bus-list></bus-list>",acceptedRoles:n.BussesAccessRoles}).when("/cities",{template:"<cities-list></cities-list>"}).when("/signup",{template:"<sign-up></sign-up>",allowAnonymus:!0}).when("/login",{template:"<sign-in></sign-in>",allowAnonymus:!0}).when("/agents",{template:"<agent-list></agent-list>"}).when("/agentReports",{template:"<agent-reports></agent-reports>"}).when("/driverReports",{template:"<driver-reports></driver-reports>"}).when("/access-forbidden",{templateUrl:"Content/app/access-forbidden.html",allowAnonymus:!0}).when("/manageAccount",{template:"<manage-account></manage-account>",acceptedRoles:n.AllRoles}).otherwise("/trips")}]).run(["$rootScope","$location","AuthService",function(e,t,n){e.$on("$routeChangeStart",function(e,r){var a=n.authData.role;return r.acceptedRoles=r.acceptedRoles?r.acceptedRoles:[],!!r.allowAnonymus||("Admin"!=a&&r.acceptedRoles.indexOf(a)==-1&&(n.authData.isAuth?t.path("/access-forbidden"):t.path("/login")),!0)})}]),angular.module("VektorApp").animation(".client",function(){function e(e,t,n){if("selected"===t)return e.css({display:"block",position:"absolute",top:500,left:0}).animate({top:0},n),function(t){t&&e.stop()}}function t(e,t,n){if("selected"===t)return e.css({position:"absolute",top:0,left:0}).animate({top:-500},n),function(t){t&&e.stop()}}return{addClass:e,removeClass:t}}),angular.module("core",["core.client","core.trip","core.bus","core.city","core.manageAccount","core.driver","core.agent","core.agentReport","core.driverReport","core.clientTrip","core.authentication"]),angular.module("core").filter("checkmark",function(){return function(e){return e?"✓":"✘"}}),angular.module("core.client",["ngResource"]),angular.module("core.client").factory("Client",["$resource",function(e){return e("/api/clients/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.clientTrip",["ngResource"]),angular.module("core.clientTrip").factory("ClientTrip",["$resource",function(e){return e("/api/clientTrips/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.trip",["ngResource"]),angular.module("core.trip").factory("Trip",["$resource",function(e){return e("/api/trips/:Id",{},{query:{method:"GET",isArray:!0},get:{method:"GET",params:{Id:"id"}},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE"}})}]),angular.module("core.trip").factory("tripCashService",function(){return{countDriverCashBox:function(e){var t=function(e,t){return e+t.Cost},n=e.compulsoryExpenses.reduce(t,0),r=e.unexpectedExpenses.reduce(t,0),a=e.tripClients.reduce(function(e,t){return e+t.Price},0);return a-(n+r)}}}),angular.module("core.driver",["ngResource"]),angular.module("core.driver").factory("Driver",["$resource",function(e){return e("/api/drivers/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.bus",["ngResource"]),angular.module("core.bus").factory("Bus",["$resource",function(e){return e("/api/buses/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.city",["ngResource"]),angular.module("core.city").service("City",["$resource",function(e){return e("/api/Cities/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.agent",["ngResource"]),angular.module("core.agent").factory("Agent",["$resource",function(e){return e("/api/agents/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.agentReport",["ngResource"]),angular.module("core.agentReport").factory("AgentReport",["$resource",function(e){return e("/api/agentReports/",{},{query:{method:"GET",isArray:!0,params:{id:"@id",dateFrom:"@dateFrom",dateTo:"@dateTo"}}})}]),angular.module("core.driverReport",["ngResource"]),angular.module("core.driverReport").factory("DriverReport",["$resource",function(e){return e("/api/driverReports/",{},{query:{method:"GET",isArray:!0,params:{id:"@id",dateFrom:"@dateFrom",dateTo:"@dateTo"}}})}]),angular.module("core.authentication",[]);var authDataResourceKey="authorizationData";angular.module("core.authentication").factory("AuthService",["localStorageService","$http","$q",function(e,t,n){var r={},a=[],o=e.get(authDataResourceKey);r.authData={isAuth:null!=o,name:o?o.name:"",role:o?o.role:"guest"},r.registerObserverCallback=function(e){a.push(e)};var i=function(){angular.forEach(a,function(e){e()})};return r.saveRegistration=function(e){return r.logOut(),t.post("/api/Account/Register",e).then(function(e){return e})},r.logOut=function(){e.remove(authDataResourceKey),r.authData.isAuth=!1,r.authData.role="",r.authData.name="",i()},r.login=function(a){var o="grant_type=password&username="+a.email+"&password="+a.password,l=n.defer();return t.post("/api/token",o,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(t){e.set(authDataResourceKey,{token:t.data.access_token,name:t.data.name,role:t.data.role}),r.authData.isAuth=!0,r.authData.name=t.data.name,r.authData.role=t.data.role,i(),l.resolve(t)},function(e,t){r.logOut(),l.reject(e)}),l.promise},r.UpdateAuthData=function(t,n){var a=e.get(authDataResourceKey),o=n?n:a.name;e.set(authDataResourceKey,{token:a.token,name:o}),r.authData.name=o,i()},r}]),angular.module("core.authentication").factory("authInterceptorService",["$q","$injector","$location","localStorageService",function(e,t,n,r){var a={};return a.request=function(e){e.headers=e.headers||{};var t=r.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},a.responseError=function(r){if(401===r.status){var a=t.get("authService");a.logOut(),n.path("/login")}return e.reject(r)},a}]),angular.module("core.manageAccount",[]),angular.module("core.manageAccount").factory("ManageAccountService",["$http",function(e){var t={};return t.updateAccount=function(t){return e.put("/api/Account/",t).then(function(e){return e})},t.getAccountInfo=function(){return e.get("/api/Account/").then(function(e){return e.data})},t}]),angular.module("clientTripList",["core.clientTrip"]),angular.module("clientTripList").component("clientTripList",{templateUrl:"Content/app/clientTrip-list/clientTrip-list.template.html",controller:["ClientTrip","$scope","City","Agent",function(e,t,n,r){var a=this;this.clientFilter="",this.clients=[],this.cities=n.query(),this.agents=r.query(),this.orderProp="Id",this.removeFromTrip=function(e){var n=t.$parent.$ctrl.trip.tripClients.indexOf(e);t.$parent.$ctrl.trip.tripClients.splice(n,1)},this.addToTrip=function(e){t.$parent.$ctrl.trip.tripClients.indexOf(e)===-1?t.$parent.$ctrl.trip.tripClients.push(e):console.log("This item already exists")},this.clientFilterAction=function(){a.clientFilter.length>1?e.query({filter:a.clientFilter},function(e){a.clients=e}):a.clients=[]},this.filterThrottled=_.debounce(a.clientFilterAction,500),t.$watch("$ctrl.clientFilter",a.filterThrottled),t.$on("clearClientTripsEvent",function(e,t){a.clientFilter="",a.clients=[]})}]}),angular.module("clientDetail",["ngRoute","core.client"]),angular.module("clientDetail").component("clientDetail",{templateUrl:"Content/app/client-detail/client-detail.template.html",controller:["$routeParams","Client",function(e,t){var n=this;n.client=t.get({clientId:e.clientId},function(e){})}]}),angular.module("tripList",["core.trip","core.bus","ngMap","googleMaps"]),angular.module("tripList").component("tripList",{templateUrl:"Content/app/trip-list/trip-list.template.html",controller:["Trip","Bus","City","Driver","$uibModal","$scope","PdfMaker","$filter","googleMapsService","tripCashService",function(e,t,n,r,a,o,i,l,s,c){var d=this;this.showAddTripForm=!1,this.isEditMode=!1,this.dateNow=new Date,this.mapCenterLatLng="49.361625, 32.139730",this.trip={tripClients:[],compulsoryExpenses:[],unexpectedExpenses:[],startDate:d.dateNow,startTime:d.dateNow,endDate:d.dateNow,endTime:d.dateNow},this.trips=e.query(),this.buses=t.query(),this.cities=n.query(),this.drivers=r.query(),this.dateFormat="dd-MMM-yyyy",this.dateOptions={minDate:new Date,showWeeks:!1,startingDay:1},this.timeOptions={minuteStep:5},this.startDatePopup={opened:!1},this.startDateOpen=function(){d.startDatePopup.opened=!0},this.endDatePopup={opened:!1},this.endDateOpen=function(){d.endDatePopup.opened=!0},this.showAddForm=function(){d.showAddTripForm=!d.showAddTripForm},this.add=function(){return d.submitted=!0,0===d.trip.tripClients.length?void o.form.$setValidity("isAnyClient",!1):void(o.form.$invalid||(d.isEditMode?d.update():d.create()))},this.create=function(){d.joinTripDateAndTime(),e.add(d.trip,function(e){d.trips.push(e),d.showAddTripForm=!1,d.clearTripModel()})},this.update=function(){d.joinTripDateAndTime(),e.update({id:d.trip.id},d.trip,function(e){d.showAddTripForm=!1,d.clearTripModel()})},this.clearTripModel=function(){d.dateNow=new Date,d.isEditMode=!1,d.trip={tripClients:[],startDate:d.dateNow,startTime:d.dateNow,endDate:d.dateNow,endTime:d.dateNow},d.submitted=!1,o.form.$setPristine(),o.form.$setUntouched(),o.$broadcast("clearClientTripsEvent")},this.joinTripDateAndTime=function(){d.trip.date=new Date(Date.UTC(d.trip.startDate.getFullYear(),d.trip.startDate.getMonth(),d.trip.startDate.getDate(),d.trip.startTime.getHours(),d.trip.startTime.getMinutes())),d.trip.arrivalDate=new Date(Date.UTC(d.trip.endDate.getFullYear(),d.trip.endDate.getMonth(),d.trip.endDate.getDate(),d.trip.endTime.getHours(),d.trip.endTime.getMinutes()))},this.openDriversList=function(){var e={animation:!0,backdrop:"static",size:"lg",component:"driverList",resolve:{drivers:function(){return d.drivers}}},t=a.open(e);t.result.then(function(e){d.drivers=e})},this.createPDF=function(e){for(var t=[[{text:"Имя Фамилия",style:"tableHeader"},{text:"Телефон",style:"tableHeader"},{text:"Куда",style:"tableHeader"},{text:"Откуда",style:"tableHeader"},{text:"Стоимость",style:"tableHeader"},{text:"Не выходит",style:"tableHeader"},{text:"Статус",style:"tableHeader"}]],n=0;n<e.tripClients.length;n++)t.push([e.tripClients[n].Name,e.tripClients[n].Phone,e.tripClients[n].To?e.tripClients[n].To:"",e.tripClients[n].From?e.tripClients[n].From:"",e.tripClients[n].Price.toString(),e.tripClients[n].IsStayInBus?"Да":"",(e.tripClients[n].HasMinorChild?"С ребенком; ":"")+(e.tripClients[n].HasDisability?"Инвалид":"")]);var r=[[{text:"Стоимость",style:"tableHeader"},{text:"Комментарий",style:"tableHeader"}]],a=[[{text:"Стоимость",style:"tableHeader"},{text:"Комментарий",style:"tableHeader"}]];e.compulsoryExpenses.map(function(e){return r.push([e.Cost.toString(),e.Comment])}),e.unexpectedExpenses.map(function(e){return a.push([e.Cost.toString(),e.Comment])});var o=null!=e.bus?e.bus.FriendlyName+" "+e.bus.RegistrationNumber+", ":"",d=null!=e.driver?"Водитель: "+e.driver.FullName:"",u=e.cityFrom.Name.concat(" - ",e.cityTo.Name," ",l("date")(e.date,"yyyy/MM/dd"),".pdf");s.getGoogleMapsImage(e.cityFrom.Name,e.cityTo.Name,function(n){var s={fileName:u,docDefinition:{pageOrientation:"portrait",fontSize:12,content:[{text:e.cityFrom.Name.concat(" --> ",e.cityTo.Name," ",l("date")(e.date,"yyyy-MM-dd HH:mm"))},{text:o+d},{text:" "},{columns:[{width:"50%",text:"Обязательные расходы:"},{width:"50%",text:"Дополнительные расходы:"}]},{columns:[{width:"50%",table:{headerRows:1,body:r}},{width:"50%",table:{headerRows:1,body:a}}]},{text:" "},{text:"Касса водителя: "+c.countDriverCashBox(e)},{text:" "},{text:"Клиенты:"},{table:{headerRows:1,body:t}},{text:" "},{image:n}]}};i.createAndDownload(s)})},this.editTrip=function(e){var t=new Date(e.date),n=new Date(e.arrivalDate);d.isEditMode=!0,d.trip=e,d.trip.startDate=t,d.trip.startTime=t,d.trip.endDate=n,d.trip.endTime=n,d.showAddTripForm=!0},this.disableEditMode=function(){d.showAddTripForm=!1,d.isEditMode=!1,d.clearTripModel()},this.delete=function(t){var n="Вы уверены, что хотите удалить маршрут "+t.cityFrom.Name+"---->"+t.cityTo.Name+", "+t.date+"?";confirm(n)&&e.remove({id:t.id},function(e){var t=d.trips.map(function(e){return e.id}).indexOf(e.id);t>-1&&d.trips.splice(t,1)},function(e){var t="Маршрут не удален. Ошибка удаления: "+e.data.Message;alert(t)})},this.addCompolsoryExpense=function(e,t){e&&t&&(d.trip.compulsoryExpenses.push({Comment:t,Cost:e}),d.compulsoryNewCost=0,d.compulsoryNewComment="")},this.addUnexpectedExpens=function(e,t){e&&t&&(d.trip.unexpectedExpenses.push({Comment:t,Cost:e}),d.unexpectedNewCost=0,d.unexpectedNewComment="")},this.getDriverCashbox=function(e){return c.countDriverCashBox(e)},this.mapInitialized=function(e){google.maps.event.trigger(e,"resize"),e.setZoom(5)},o.$watchCollection("$ctrl.trip.tripClients",function(e,t){e&&e.length>0&&o.form.$setValidity("isAnyClient",!0)})}]}),angular.module("driverList",["core.driver"]),angular.module("driverList").component("driverList",{templateUrl:"Content/app/driver-list/driver-list.template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["Driver","$scope","$uibModal",function(e,t,n){var r=this;r.drivers=[],r.addDriverBlockVisible=!1,r.addNewClass="",r.$onInit=function(){r.drivers=r.resolve.drivers},r.closeModal=function(){r.close({$value:r.drivers})},r.editDriver=function(e){t.$broadcast("editDriverEvent",{driver:e})},r.showAddDriverBlock=function(){r.addDriverBlockVisible=!r.addDriverBlockVisible,r.addNewClass=r.addDriverBlockVisible?"not-active":""},r.deleteDriver=function(e){t.$broadcast("deleteDriverEvent",{id:e})}}]}),angular.module("driverCrud",["core.driver"]),angular.module("driverCrud").component("driverCrud",{templateUrl:"Content/app/driver-list/driver-crud/driver-crud.template.html",controller:["Driver","$scope",function(e,t){var n=this;this.maxPhotoWidth=150,this.maxPhotoHeight=150,this.driver={},this.cancel=function(){t.$parent.$ctrl.showAddDriverBlock()},this.save=function(r){n.driver=r,r.Id>0?e.update({id:r.Id},r,function(e){t.$parent.$ctrl.showAddDriverBlock(),n.driver={}}):e.add(r,function(e){t.$parent.$ctrl.drivers.push(e),t.$parent.$ctrl.showAddDriverBlock(),n.driver={}})},this.deleteDriver=function(n){e.delete({id:n},function(e){var n=t.$parent.$ctrl.drivers.map(function(e){return e.Id}).indexOf(e.Id);n>-1&&t.$parent.$ctrl.drivers.splice(n,1)})},t.$on("deleteDriverEvent",function(e,t){n.deleteDriver(t.id)}),t.$on("editDriverEvent",function(e,r){n.driver=r.driver,$("#photoPreview").attr("src","data:image/png;base64,"+n.driver.Photo),t.$parent.$ctrl.showAddDriverBlock()}),this.resizeBase64Img=function(e,t,n){var r=document.createElement("canvas"),a=$.Deferred();return $("<img/>").attr("src",e).load(function(){var e=this.width,o=this.height;e>o?e>t&&(o*=t/e,e=t):o>n&&(e*=n/o,o=n),r.width=e,r.height=o;var i=r.getContext("2d");i.drawImage(this,0,0,e,o),a.resolve($("<img/>").attr("src",r.toDataURL()))}),a.promise()},$("#driverPhoto").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){n.resizeBase64Img(e.target.result,n.maxPhotoWidth,n.maxPhotoHeight).then(function(e){n.driver.Photo=e[0].src.replace("data:image/png;base64,",""),console.log(e[0].src),$("#photoPreview").attr("src",e[0].src)})},e.readAsDataURL(this.files[0])}})}]}),angular.module("modalBus",["core.bus"]),angular.module("modalBus").component("modalBus",{templateUrl:"Content/app/bus-list/modal/modalBus-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:function(){var e=this;e.$onInit=function(){e.bus=e.resolve.bus,e.bus&&e.bus.Id>0?e.headerTitle="Редактирование":e.headerTitle="Создание"},e.ok=function(){e.close({$value:e.bus})},e.cancel=function(){e.dismiss({$value:"cancel"})}}}),angular.module("busList",["core.bus"]),angular.module("busList").component("busList",{templateUrl:"Content/app/bus-list/bus-list.template.html",controller:["Bus","$scope","$uibModal",function(e,t,n){var r=this;r.buses=e.query(),r.bus={};var a={animation:!0,backdrop:"static",component:"modalBus",resolve:{bus:function(){return r.bus}}};r.addBus=function(){var t=n.open(a);t.result.then(function(t){r.bus=t,e.add(t,function(e){r.buses.push(e),r.clearBus()})})},r.editBus=function(t){r.bus=t;var o=n.open(a);o.result.then(function(t){r.bus=t,e.update({id:t.Id},t,r.clearBus)},r.clearBus)},r.deleteBus=function(t){e.delete({id:t},function(e){var t=r.buses.map(function(e){return e.Id}).indexOf(e.Id);t>-1&&r.buses.splice(t,1)})},r.clearBus=function(){r.bus={}}}]}),angular.module("agentList",["core.agent"]),angular.module("agentList").component("agentList",{templateUrl:"Content/app/agent-list/agent-list.template.html",controller:["Agent","$scope","$uibModal",function(e,t,n){var r=this;r.agents=e.query(),r.agent={};var a={animation:!0,backdrop:"static",component:"modalAgent",resolve:{agent:function(){return r.agent}}};r.addAgent=function(){var t=n.open(a);t.result.then(function(t){r.agent=t,e.add(t,function(e){r.agents.push(e),r.clearAgent()})})},r.editAgent=function(t){r.agent=t;var o=n.open(a);o.result.then(function(t){r.agent=t,e.update({id:t.Id},t,r.clearAgent)},r.clearAgent)},r.deleteAgent=function(t){e.delete({id:t},function(e){var t=r.agents.map(function(e){return e.Id}).indexOf(e.Id);t>-1&&r.agents.splice(t,1)},function(e){var t=e.data.Message;alert(t)})},r.clearAgent=function(){r.agent={}}}]}),angular.module("modalAgent",["core.agent"]),angular.module("modalAgent").component("modalAgent",{templateUrl:"Content/app/agent-list/modal/modalAgent-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:function(){var e=this;e.$onInit=function(){e.agent=e.resolve.agent,e.agent&&e.agent.Id>0?e.headerTitle="Редактирование":e.headerTitle="Создание"},e.ok=function(){e.close({$value:e.agent})},e.cancel=function(){e.dismiss({$value:"cancel"})}}}),angular.module("reports",[]),angular.module("reports").component("agentReports",{templateUrl:"Content/app/reports/agent-reports.template.html",controller:["Agent","AgentReport","$filter","PdfMaker",function(e,t,n,r){var a=this;a.agents=e.query(),a.agent={},a.dateTimeFormat="dd/MM/yyyy",a.dateFrom=new Date,a.dateTo=new Date,a.dateOptions={showWeeks:!1,startingDay:0,maxDate:new Date},a.reports=[],a.reportTitle="",a.totalTitle="",a.totalPrice="",a.reportIsShowing=!1,a.startDatePopup={opened:!1},a.startDateOpen=function(){a.startDatePopup.opened=!0},a.endDatePopup={opened:!1},a.endDateOpen=function(){a.endDatePopup.opened=!0},a.onGetReports=function(e){a.reports=e,a.reportTitle="Отчет по агенту "+a.agent.FullName,a.totalTitle="Итого за период с "+n("date")(a.dateFrom,"yyyy-MM-dd")+" по "+n("date")(a.dateTo,"yyyy-MM-dd")+": ",a.totalPrice=0,a.reportIsShowing=!0;for(var t=0;t<e.length;t++)a.totalPrice+=e[t].AgentCompensation},a.createReport=function(){a.reportTitle="",a.totalTitle="",a.totalPrice="";var e={id:a.agent.Id,dateFrom:n("date")(a.dateFrom,"yyyy-MM-dd"),dateTo:n("date")(a.dateTo,"yyyy-MM-dd")};t.query(e,a.onGetReports)},a.createPDF=function(e){var t=[[{text:"Дата Отправления",style:"tableHeader"},{text:"Откуда",style:"tableHeader"},{text:"Куда",style:"tableHeader"},{text:"Автобус",style:"tableHeader"},{text:"Водитель",style:"tableHeader"},{text:"Кол-во пассажиров",style:"tableHeader"},{text:"Компенсация за рейс",style:"tableHeader"}]];e.map(function(e){return t.push([e.TripDate,e.CityFrom,e.CityTo,e.BusInfo,e.DriverInfo,e.ClientsCount.toString(),e.AgentCompensation.toString()])});var o=n("date")(a.dateFrom,"yyyy-MM-dd").concat(" - ",n("date")(a.dateTo,"yyyy-MM-dd")),i={fileName:"Oтчет "+o+" "+a.agent.FullName,docDefinition:{pageOrientation:"portrait",fontSize:12,content:[{text:"Агент: "+a.agent.FullName},{text:"Oтчет за период: "+o},{text:" "},{table:{headerRows:1,body:t}},{text:" "},{text:a.totalTitle+" "+a.totalPrice}]}};r.createAndDownload(i)}}]}),angular.module("reports").component("driverReports",{templateUrl:"Content/app/reports/driver-reports.template.html",controller:["Driver","DriverReport","$filter","PdfMaker",function(e,t,n,r){var a=this;a.drivers=e.query(),a.driver={},a.dateTimeFormat="dd/MM/yyyy",a.dateFrom=new Date,a.dateTo=new Date,a.dateOptions={showWeeks:!1,startingDay:0,maxDate:new Date},a.reports=[],a.reportTitle="",a.totalTitle="",a.totalPrice="",a.reportIsShowing=!1,a.startDatePopup={opened:!1},a.startDateOpen=function(){a.startDatePopup.opened=!0},a.endDatePopup={opened:!1},a.endDateOpen=function(){a.endDatePopup.opened=!0},a.onGetReports=function(e){a.reports=e,a.reportTitle="Отчет по водителю "+a.driver.FullName,a.totalTitle="Итого за период с "+n("date")(a.dateFrom,"yyyy-MM-dd")+" по "+n("date")(a.dateTo,"yyyy-MM-dd")+": ",a.totalPrice=e.reduce(function(e,t){return e+t.DriverCashBox},0),a.reportIsShowing=!0},a.createReport=function(){a.reportTitle="",a.totalTitle="",a.totalPrice="",a.reportIsShowing=!1;var e={id:a.driver.Id,dateFrom:n("date")(a.dateFrom,"yyyy-MM-dd"),dateTo:n("date")(a.dateTo,"yyyy-MM-dd")};t.query(e,a.onGetReports)},a.createPDF=function(e){var t=[[{text:"Дата Отправления",style:"tableHeader"},{text:"Откуда",style:"tableHeader"},{text:"Куда",style:"tableHeader"},{text:"Автобус",style:"tableHeader"},{text:"Кол-во пассажиров",style:"tableHeader"},{text:"Постоянные расходы",style:"tableHeader"},{text:"Непред. расходы",style:"tableHeader"},{text:"Касса",style:"tableHeader"}]];e.map(function(e){return t.push([e.TripDate,e.CityFrom,e.CityTo,e.BusInfo,e.ClientsCount?e.ClientsCount.toString():"",e.CompulsoryExpenses?e.CompulsoryExpenses.toString():0,e.UnexpectedExpenses?e.UnexpectedExpenses.toString():0,e.DriverCashBox?e.DriverCashBox.toString():0])});var o=n("date")(a.dateFrom,"yyyy-MM-dd").concat(" - ",n("date")(a.dateTo,"yyyy-MM-dd")),i={fileName:"Oтчет "+o+" "+a.driver.FullName,docDefinition:{pageOrientation:"portrait",fontSize:12,content:[{text:"Водитель: "+a.driver.FullName},{text:"Oтчет за период: "+o},{text:" "},{table:{headerRows:1,body:t}},{text:" "},{text:a.totalTitle+" "+a.totalPrice}]}};r.createAndDownload(i)}}]}),angular.module("clientList",["core.client"]),angular.module("clientList").component("clientList",{templateUrl:"Content/app/client-list/client-list.template.html",controller:["Client","Trip","$scope","$uibModal",function(e,t,n,r){var a=this;a.clients=e.query(),a.client={};var o={animation:!0,backdrop:"static",component:"modalClient",resolve:{client:function(){return a.client}}};a.addClient=function(){var t=r.open(o);t.result.then(function(t){a.client=t,e.add(t,function(e){a.clients.push(e),a.clearClient()})})},a.editClient=function(t){a.client=t;var n=r.open(o);n.result.then(function(t){a.client=t,e.update({id:t.Id},t,a.clearClient)},a.clearClient)},a.deleteClient=function(t){e.delete({id:t},function(e){var t=a.clients.map(function(e){return e.Id}).indexOf(e.Id);t>-1&&a.clients.splice(t,1)})},a.clientInfo=function(e){t.query({clientId:e.Id},function(t){var n={animation:!0,backdrop:"static",component:"modalClientTrips",size:"lg",resolve:{info:function(){return{client:e,trips:t}}}};r.open(n)})},a.clearClient=function(){a.client={}}}]}),angular.module("modalClient",["core.client"]),angular.module("modalClient").component("modalClient",{templateUrl:"Content/app/client-list/modal/modalClient-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:function(){var e=this;e.$onInit=function(){e.client=e.resolve.client,e.client&&e.client.Id>0?e.headerTitle="Редактирование":e.headerTitle="Создание"},e.ok=function(){e.close({$value:e.client})},e.cancel=function(){e.dismiss({$value:"cancel"})}}}),angular.module("modalClient").component("modalClientTrips",{templateUrl:"Content/app/client-list/modal/modalClientTrips-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$filter",function(e){var t=this;t.trips={},t.client={},t.headerTitle="",t.$onInit=function(){t.trips=t.resolve.info.trips,t.client=t.resolve.info.client,t.headerTitle="Информация о поездках клиента "+t.client.Name},t.getClienPrice=function(n){var r=e("filter")(n,{ClientId:t.client.Id},!0);return r[0].Price},t.getClienAdditionalExpenses=function(n){var r=e("filter")(n,{ClientId:t.client.Id},!0);return r[0].AdditionalExpenses},t.cancel=function(){t.dismiss({$value:"cancel"})}}]}),angular.module("citiesList",["core.city","google.places"]),angular.module("citiesList").component("citiesList",{templateUrl:"Content/app/cities-list/cities-list.template.html",controller:["City","$scope",function(e,t){var n=this;this.cities=e.query(),this.showAddCityForm=!1,this.choosedPlace="",this.showAddForm=function(){n.showAddCityForm=!n.showAddCityForm},t.autocompleteOptions={componentRestrictions:{country:"ukr"},types:["(cities)"]},this.saveCity=function(){if(n.choosedPlace){n.showAddCityForm=!1;var t=n.choosedPlace.name?n.choosedPlace.name:n.choosedPlace;e.add({name:t},function(){n.cities=e.query(),n.choosedPlace=""})}},this.removeCity=function(t){e.remove({id:t}),function(){n.cities=n.cities.filter(function(e){return e.id!=t})}},this.setCityFromAutocomplete=function(e,t){n.city.name=t}}]}),angular.module("pdfMaker",[]),angular.module("pdfMaker").factory("PdfMaker",function(){return{createAndDownload:function(e){pdfMake.createPdf(e.docDefinition).download(e.fileName?e.fileName:"file.pdf")},createAndOpen:function(e){pdfMake.createPdf(e.docDefinition).open()}}}),angular.module("signUp",["core.authentication"]),angular.module("signUp").component("signUp",{templateUrl:"Content/app/authentication/signup/signup.template.html",controller:["AuthService","$location",function(e,t){var n=this;this.savedSuccessfully=!1,this.message="",this.registration={email:"",password:"",confirmPassword:""},this.signUp=function(r){r&&e.saveRegistration(this.registration).then(function(e){n.savedSuccessfully=!0,n.message="User has been registered successfully, you will be redirected to login page in 2 seconds.",t.path("/login")},function(e){var t=[];for(var r in e.data.ModelState)for(var a=0;a<e.data.ModelState[r].length;a++)t.push(e.data.ModelState[r][a]);n.message=t.join("\n")})}}]}),angular.module("signIn",["core.authentication"]),angular.module("signIn").component("signIn",{templateUrl:"Content/app/authentication/signin/signin.template.html",controller:["AuthService","$location",function(e,t){var n=this;e.authData.isAuth&&(e.logOut(),t.path("/login")),this.loginData={email:"",password:""},this.message="",this.login=function(){e.login(this.loginData).then(function(e){t.path("/trips")},function(e){n.message=e.data.error_description})}}]}),angular.module("navBar",["core.authentication"]),angular.module("navBar").component("navbar",{templateUrl:"Content/app/navbar/navbar.template.html",controller:["AuthService","authConstants",function(e,t){var n=this;this.ClientAccessRoles=t.ClientAccessRoles,this.BusesAccessRoles=t.BussesAccessRoles,this.updateAuthData=function(){n.isAuth=e.authData.isAuth,n.currentRole=e.authData.role},e.registerObserverCallback(n.updateAuthData),this.isAuth=e.authData.isAuth,this.currentRole=e.authData.role,this.hasRole=function(e){return!!n.isAuth&&(e?e.indexOf(n.currentRole)!=-1||"Admin"==n.currentRole:"Admin"==n.currentRole)}}]}),angular.module("VektorApp").directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,n,r){r.$validators.compareTo=function(t){return t==e.otherModelValue},e.$watch("otherModelValue",function(){r.$validate()})}}}),angular.module("manageAccount",["core.manageAccount","core.authentication"]),angular.module("manageAccount").component("manageAccount",{templateUrl:"Content/app/manage-account/manage-account.template.html",controller:["ManageAccountService","AuthService",function(e,t){var n=this;this.message="",this.updateSuccefull=null,this.accountData={},e.getAccountInfo().then(function(e){n.accountData.email=e.Email,n.accountData.name=e.Name}),this.update=function(r){r&&e.updateAccount(this.accountData).then(function(){n.message="Account has been successfully updated",n.updateSuccefull=!0,t.UpdateAuthData(n.accountData.email,n.accounData.name)},function(e){var t=[];for(var r in e.data.ModelState)for(var a=0;a<e.data.ModelState[r].length;a++)t.push(e.data.ModelState[r][a]);n.message=t.join("\n"),n.updateSuccefull=!1})}}]}),angular.module("googleMaps",[]),angular.module("googleMaps").factory("googleMapsService",["$http","$q",function(e,t){var n={},r=new google.maps.DirectionsService,a="https://maps.googleapis.com/maps/api/staticmap?size=500x400&zoom=7&maptype=roadmap";return n.getGoogleMapsImage=function(e,t,o){r.route({origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING},function(r){var i=a.concat("&markers=color:green|label:A|",e,"&markers=color:red|label:B|",t,"&path=color:0x0000ff80|weight:5|enc:",r.routes[0].overview_polyline,"&key=AIzaSyBkEIsxJ1ZqsEBPUYsef_jF2ajuSkmbxJ4");n.convertImgToDataURL(i,o)})},n.convertImgToDataURL=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){var e,n=document.createElement("CANVAS"),r=n.getContext("2d");n.height=this.height,n.width=this.width,r.drawImage(this,0,0),e=n.toDataURL(),t(e),n=null},n.src=e},n}]),angular.module("VektorApp").directive("loading",["$http","$timeout",function(e,t){return{restrict:"A",link:function(t,n,r){t.isLoading=function(){return e.pendingRequests.length>0},t.$watch(t.isLoading,function(e){e?n.show():n.hide()})}}}]);
//# sourceMappingURL=maps/all.min.js.map
