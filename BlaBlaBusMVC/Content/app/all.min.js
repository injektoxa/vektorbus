"use strict";angular.module("VektorApp",["ngAnimate","ngRoute","ui.bootstrap","core","pdfMaker","clientDetail","clientList","clientTripList","tripList","busList","modalBus","driverList","driverCrud","citiesList","agentList","modalAgent","modalClient","reports","signUp","signIn","LocalStorageModule","navBar","manageAccount","googleMaps"]),angular.module("VektorApp").constant("authConstants",{ClientAccessRoles:["Driver"],BussesAccessRoles:["Driver","Partner"],AllRoles:["User","Driver","Partner"]}).config(["$locationProvider","$routeProvider","authConstants","$httpProvider","$qProvider",function(e,t,n,o,r){o.interceptors.push("authInterceptorService"),o.defaults.useXDomain=!0,delete o.defaults.headers.common["X-Requested-With"],e.html5Mode(!0),r.errorOnUnhandledRejections(!1),t.when("/clients",{template:"<client-list></client-list>",acceptedRoles:n.ClientAccessRoles}).when("/clients/:clientId",{template:"<client-detail></client-detail>"}).when("/trips",{template:"<trip-list></trip-list>",acceptedRoles:n.AllRoles}).when("/buses",{template:"<bus-list></bus-list>",acceptedRoles:n.BussesAccessRoles}).when("/cities",{template:"<cities-list></cities-list>"}).when("/signup",{template:"<sign-up></sign-up>",allowAnonymus:!0}).when("/login",{template:"<sign-in></sign-in>",allowAnonymus:!0}).when("/agents",{template:"<agent-list></agent-list>"}).when("/agentReports",{template:"<agent-reports></agent-reports>"}).when("/driverReports",{template:"<driver-reports></driver-reports>"}).when("/access-forbidden",{templateUrl:"Content/app/access-forbidden.html",allowAnonymus:!0}).when("/manageAccount",{template:"<manage-account></manage-account>",acceptedRoles:n.AllRoles}).otherwise("/trips")}]).run(["$rootScope","$location","AuthService",function(e,t,n){e.$on("$routeChangeStart",function(e,o){var r=n.authData.role;return o.acceptedRoles=o.acceptedRoles?o.acceptedRoles:[],!!o.allowAnonymus||("Admin"!=r&&-1==o.acceptedRoles.indexOf(r)&&(n.authData.isAuth?t.path("/access-forbidden"):t.path("/login")),!0)})}]),angular.module("VektorApp").animation(".client",function(){function e(e,t,n){if("selected"===t)return e.css({display:"block",position:"absolute",top:500,left:0}).animate({top:0},n),function(t){t&&e.stop()}}function t(e,t,n){if("selected"===t)return e.css({position:"absolute",top:0,left:0}).animate({top:-500},n),function(t){t&&e.stop()}}return{addClass:e,removeClass:t}}),angular.module("core",["core.client","core.trip","core.bus","core.city","core.manageAccount","core.driver","core.agent","core.agentReport","core.driverReport","core.clientTrip","core.authentication"]),angular.module("core").filter("checkmark",function(){return function(e){return e?"✓":"✘"}}),angular.module("core.client",["ngResource"]),angular.module("core.client").factory("Client",["$resource",function(e){return e("/api/clients/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.clientTrip",["ngResource"]),angular.module("core.clientTrip").factory("ClientTrip",["$resource",function(e){return e("/api/clientTrips/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.trip",["ngResource"]),angular.module("core.trip").factory("Trip",["$resource",function(e){return e("/api/trips/:Id",{},{query:{method:"GET",isArray:!0},get:{method:"GET",params:{Id:"id"}},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE"}})}]);var expenseSumFun=function(e,t){return e+t.Cost};angular.module("core.trip").factory("tripCashService",function(){return{countIncomes:function(e){var t=this.countTotalExpenses(e);return this.countDriverCashBox(e)-(t.compolsuryTotal+t.unexpectedTotal+t.agentExpensesTotal)},countDriverCashBox:function(e){return e.tripClients?e.tripClients.reduce(function(e,t){return e+t.Price},0):0},countAgentExpenses:function(e){return e.tripClients?e.tripClients.reduce(function(e,t){return e+t.AgentPrice},0):0},countTotalExpenses:function(e){return{compolsuryTotal:e.compulsoryExpenses?e.compulsoryExpenses.reduce(expenseSumFun,0):0,unexpectedTotal:e.unexpectedExpenses?e.unexpectedExpenses.reduce(expenseSumFun,0):0,agentExpensesTotal:this.countAgentExpenses(e)}}}}),angular.module("core.driver",["ngResource"]),angular.module("core.driver").factory("Driver",["$resource",function(e){return e("/api/drivers/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.bus",["ngResource"]),angular.module("core.bus").factory("Bus",["$resource",function(e){return e("/api/buses/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.city",["ngResource"]),angular.module("core.city").service("City",["$resource",function(e){return e("/api/Cities/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.agent",["ngResource"]),angular.module("core.agent").factory("Agent",["$resource",function(e){return e("/api/agents/:Id",{},{query:{method:"GET",isArray:!0},add:{method:"POST"},update:{method:"PUT"},remove:{method:"DELETE",params:{Id:"id"}}})}]),angular.module("core.agentReport",["ngResource"]),angular.module("core.agentReport").factory("AgentReport",["$resource",function(e){return e("/api/agentReports/",{},{query:{method:"GET",isArray:!0,params:{id:"@id",dateFrom:"@dateFrom",dateTo:"@dateTo"}}})}]),angular.module("core.driverReport",["ngResource"]),angular.module("core.driverReport").factory("DriverReport",["$resource",function(e){return e("/api/driverReports/",{},{query:{method:"GET",isArray:!0,params:{id:"@id",dateFrom:"@dateFrom",dateTo:"@dateTo"}}})}]),angular.module("core.authentication",[]);var authDataResourceKey="authorizationData";angular.module("core.authentication").factory("AuthService",["localStorageService","$http","$q",function(e,t,n){var o={},r=[],i=e.get(authDataResourceKey);o.authData={isAuth:null!=i,name:i?i.name:"",role:i?i.role:"guest"},o.registerObserverCallback=function(e){r.push(e)};var a=function(){angular.forEach(r,function(e){e()})};return o.saveRegistration=function(e){return o.logOut(),t.post("/api/Account/Register",e).then(function(e){return e})},o.logOut=function(){e.remove(authDataResourceKey),o.authData.isAuth=!1,o.authData.role="",o.authData.name="",a()},o.login=function(r){var i="grant_type=password&username="+r.email+"&password="+r.password,s=n.defer();return t.post("/api/token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(t){e.set(authDataResourceKey,{token:t.data.access_token,name:t.data.name,role:t.data.role}),o.authData.isAuth=!0,o.authData.name=t.data.name,o.authData.role=t.data.role,a(),s.resolve(t)},function(e,t){o.logOut(),s.reject(e)}),s.promise},o.UpdateAuthData=function(t,n){var r=e.get(authDataResourceKey),i=n||r.name;e.set(authDataResourceKey,{token:r.token,name:i}),o.authData.name=i,a()},o}]),angular.module("core.authentication").factory("authInterceptorService",["$q","$injector","$location","localStorageService",function(e,t,n,o){var r={};return r.request=function(e){e.headers=e.headers||{};var t=o.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},r.responseError=function(o){if(401===o.status){t.get("AuthService").logOut(),n.path("/login")}return e.reject(o)},r}]),angular.module("core.manageAccount",[]),angular.module("core.manageAccount").factory("ManageAccountService",["$http",function(e){var t={};return t.updateAccount=function(t){return e.put("/api/Account/",t).then(function(e){return e})},t.getAccountInfo=function(){return e.get("/api/Account/").then(function(e){return e.data})},t}]),angular.module("clientTripList",["core.clientTrip"]),angular.module("clientTripList").component("clientTripList",{templateUrl:"Content/app/clientTrip-list/clientTrip-list.template.html",controller:["ClientTrip","$scope","City","Agent",function(e,t,n,o){var r=this;this.clientFilter="",this.clients=[],this.cities=n.query(),this.agents=o.query(),this.orderProp="Id",this.removeFromTrip=function(e){var n=t.$parent.$ctrl.trip.tripClients.indexOf(e);t.$parent.$ctrl.trip.tripClients.splice(n,1)},this.addToTrip=function(e){-1===t.$parent.$ctrl.trip.tripClients.indexOf(e)?t.$parent.$ctrl.trip.tripClients.push(e):console.log("This item already exists")},this.clientFilterAction=function(){r.clientFilter.length>1?e.query({filter:r.clientFilter},function(e){r.clients=e}):r.clients=[]},this.filterThrottled=_.debounce(r.clientFilterAction,500),t.$watch("$ctrl.clientFilter",r.filterThrottled),t.$on("clearClientTripsEvent",function(e,t){r.clientFilter="",r.clients=[]})}]}),angular.module("clientDetail",["ngRoute","core.client"]),angular.module("clientDetail").component("clientDetail",{templateUrl:"Content/app/client-detail/client-detail.template.html",controller:["$routeParams","Client",function(e,t){this.client=t.get({clientId:e.clientId},function(e){})}]}),angular.module("tripList",["core.trip","core.bus","ngMap","googleMaps"]),angular.module("tripList").component("tripList",{templateUrl:"Content/app/trip-list/trip-list.template.html",controller:["Trip","Bus","City","Driver","$uibModal","$scope","PdfMaker","$filter","googleMapsService","tripCashService","$q","$timeout",function(e,t,n,o,r,i,a,s,l,c,u,d){var p=this;this.showAddTripForm=!1,this.isEditMode=!1,this.dateNow=new Date,this.mapCenterLatLng=new google.maps.LatLng(49.361625,32.13973),this.trip={tripClients:[],compulsoryExpenses:[],unexpectedExpenses:[],startDate:p.dateNow,startTime:p.dateNow,endDate:p.dateNow,endTime:p.dateNow},this.trips=e.query(),this.buses=t.query(),this.cities=n.query(),this.drivers=o.query(),this.dateFormat="dd-MMM-yyyy",this.dateTimeFormat="MMM dd HH:mm",this.dateOptions={minDate:new Date,showWeeks:!1,startingDay:1},this.timeOptions={minuteStep:5},this.startDatePopup={opened:!1},this.startDateOpen=function(){p.startDatePopup.opened=!0},this.endDatePopup={opened:!1},this.endDateOpen=function(){p.endDatePopup.opened=!0},this.showAddForm=function(){p.showAddTripForm=!p.showAddTripForm},this.add=function(){if(p.submitted=!0,0===p.trip.tripClients.length)return void i.form.$setValidity("isAnyClient",!1);i.form.$invalid||(p.isEditMode?p.update():p.create())},this.create=function(){p.joinTripDateAndTime(),e.add(p.trip,function(e){p.trips.push(e),p.showAddTripForm=!1,p.clearTripModel()})},this.update=function(){p.joinTripDateAndTime(),e.update({id:p.trip.id},p.trip,function(t){p.trips=e.query(),p.showAddTripForm=!1,p.clearTripModel()})},this.clearTripModel=function(){p.dateNow=new Date,p.isEditMode=!1,p.trip={tripClients:[],startDate:p.dateNow,startTime:p.dateNow,endDate:p.dateNow,endTime:p.dateNow},p.submitted=!1,i.form.$setPristine(),i.form.$setUntouched(),i.$broadcast("clearClientTripsEvent")},this.joinTripDateAndTime=function(){p.trip.date=new Date(p.trip.startDate.getFullYear(),p.trip.startDate.getMonth(),p.trip.startDate.getDate(),p.trip.startTime.getHours(),p.trip.startTime.getMinutes()),p.trip.arrivalDate=new Date(p.trip.endDate.getFullYear(),p.trip.endDate.getMonth(),p.trip.endDate.getDate(),p.trip.endTime.getHours(),p.trip.endTime.getMinutes())},this.openDriversList=function(){var e={animation:!0,backdrop:"static",size:"lg",component:"driverList",resolve:{drivers:function(){return p.drivers}}};r.open(e).result.then(function(e){p.drivers=e})},this.createPDF=function(e){e.directionLoadingFaled?p.createTripReportPdf(e,null):l.getGoogleMapsImage(e.cityFrom.Name,e.cityTo.Name,e.waypoints,e.polyline,function(t){p.createTripReportPdf(e,t)})},this.createTripReportPdf=function(e,t){var n=[[{text:"№",style:"tableHeader"},{text:"Имя Фамилия",style:"tableHeader"},{text:"Телефон",style:"tableHeader"},{text:"Куда",style:"tableHeader"},{text:"Откуда",style:"tableHeader"},{text:"Стоимость",style:"tableHeader"},{text:"Не вых.",style:"tableHeader"},{text:"Статус",style:"tableHeader"},{text:"Aгент",style:"tableHeader"}]];e.tripClients.map(function(e,t){return n.push([(t+1).toString(),e.Name,e.Phone,e.To?e.To:"",e.From?e.From:"",e.Price.toString(),e.IsStayInBus?"Да":"",(e.HasMinorChild?"С ребенком; ":"")+(e.HasDisability?"Инвалид":""),e.AgentName?e.AgentName+" - "+(e.AgentPrice?e.AgentPrice:0):""])});var o=[[{text:"Стоимость",style:"tableHeader"},{text:"Комментарий",style:"tableHeader"}]],r=[[{text:"Стоимость",style:"tableHeader"},{text:"Комментарий",style:"tableHeader"}]];e.compulsoryExpenses.map(function(e){return o.push([e.Cost.toString(),e.Comment])}),e.unexpectedExpenses.map(function(e){return r.push([e.Cost.toString(),e.Comment])});var i=c.countTotalExpenses(e),l=null!=e.bus?e.bus.FriendlyName+" "+e.bus.RegistrationNumber+", ":"",u=null!=e.driver?"Водитель: "+e.driver.FullName:"",d=e.cityFrom.Name.concat(" - ",e.cityTo.Name," ",s("date")(e.date,"yyyy/MM/dd"),".pdf"),p={fileName:d,docDefinition:{pageOrientation:"portrait",fontSize:12,content:[{text:e.cityFrom.Name.concat(" --\x3e ",e.cityTo.Name," ",s("date")(e.date,"yyyy-MM-dd HH:mm"))},{text:l+u},{text:" "},{columns:[{width:"50%",text:"Обязательные расходы:"},{width:"50%",text:"Дополнительные расходы:"}]},{columns:[{width:"50%",table:{headerRows:1,body:o}},{width:"50%",table:{headerRows:1,body:r}}]},{columns:[{width:"50%",text:"Итого: "+i.compolsuryTotal},{width:"50%",text:"Итого: "+i.unexpectedTotal}]},{text:" "},{text:"Клиенты:"},{table:{headerRows:1,body:n}},{text:" "},{text:"Касса водителя: "+c.countDriverCashBox(e)},{text:"Агентские по рейсу суммарно: "+i.agentExpensesTotal},{text:"Доход: "+c.countIncomes(e)},{text:" "}]}};null!=t&&p.docDefinition.content.push({image:t}),a.createAndDownload(p)},this.editTrip=function(e){var t=new Date(e.date),n=new Date(e.arrivalDate);p.isEditMode=!0,p.trip=e,p.trip.startDate=t,p.trip.startTime=t,p.trip.endDate=n,p.trip.endTime=n,p.showAddTripForm=!0},this.disableEditMode=function(){p.showAddTripForm=!1,p.isEditMode=!1,p.clearTripModel()},this.delete=function(t){var n="Вы уверены, что хотите удалить маршрут "+t.cityFrom.Name+"----\x3e"+t.cityTo.Name+", "+t.date+"?";confirm(n)&&e.remove({id:t.id},function(e){var t=p.trips.map(function(e){return e.id}).indexOf(e.id);t>-1&&p.trips.splice(t,1)},function(e){var t="Маршрут не удален. Ошибка удаления: "+e.data.Message;alert(t)})},this.removeExpense=function(e,t){e.splice(t,1)},this.addCompolsoryExpense=function(e,t){e&&t&&(p.trip.compulsoryExpenses.push({Comment:t,Cost:e}),p.compulsoryNewCost=0,p.compulsoryNewComment="")},this.addUnexpectedExpens=function(e,t){e&&t&&(p.trip.unexpectedExpenses.push({Comment:t,Cost:e}),p.unexpectedNewCost=0,p.unexpectedNewComment="")},this.getDriverCashbox=function(e){return c.countDriverCashBox(e)},this.getIncomes=function(e){return c.countIncomes(e)},this.getAgentExpenses=function(e){return c.countAgentExpenses(e)},this.mapInitialized=function(e,t){google.maps.event.trigger(e,"resize");var n=new google.maps.DirectionsRenderer;n.setMap(e),p.getTripWaypoints(t.tripClients,t.cityFrom.Name,t.cityTo.Name).then(function(e){null!=e.response?(n.setDirections(e.response),t.polyline=e.response.routes[0].overview_polyline):t.directionLoadingFaled=!0,t.waypoints=e.waypoints})},this.getTripWaypoints=function(e,t,n){var o=[],r=u.defer(),i=function(e){o.some(function(t){return t.location==e})||e==t||e==n||(e=e.concat(", Украина"),o.push({location:e,stopover:!0}))};return e.map(function(e){i(e.To),i(e.From)}),l.optimizeWaypoints(t,n,o,function(e){r.resolve(e)}),r.promise},i.$watchCollection("$ctrl.trip.tripClients",function(e,t){e&&e.length>0&&i.form.$setValidity("isAnyClient",!0)})}]}),angular.module("driverList",["core.driver"]),angular.module("driverList").component("driverList",{templateUrl:"Content/app/driver-list/driver-list.template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["Driver","$scope","$uibModal",function(e,t,n){var o=this;o.drivers=[],o.addDriverBlockVisible=!1,o.addNewClass="",o.$onInit=function(){o.drivers=o.resolve.drivers},o.closeModal=function(){o.close({$value:o.drivers})},o.editDriver=function(e){t.$broadcast("editDriverEvent",{driver:e})},o.showAddDriverBlock=function(){o.addDriverBlockVisible=!o.addDriverBlockVisible,o.addNewClass=o.addDriverBlockVisible?"not-active":""},o.deleteDriver=function(e){t.$broadcast("deleteDriverEvent",{id:e})}}]}),angular.module("driverCrud",["core.driver"]),angular.module("driverCrud").component("driverCrud",{templateUrl:"Content/app/driver-list/driver-crud/driver-crud.template.html",controller:["Driver","$scope",function(e,t){var n=this;this.maxPhotoWidth=150,this.maxPhotoHeight=150,this.driver={},this.cancel=function(){t.$parent.$ctrl.showAddDriverBlock()},this.save=function(o){n.driver=o,o.Id>0?e.update({id:o.Id},o,function(e){t.$parent.$ctrl.showAddDriverBlock(),n.driver={}}):e.add(o,function(e){t.$parent.$ctrl.drivers.push(e),t.$parent.$ctrl.showAddDriverBlock(),n.driver={}})},this.deleteDriver=function(n){e.delete({id:n},function(e){var n=t.$parent.$ctrl.drivers.map(function(e){return e.Id}).indexOf(e.Id);n>-1&&t.$parent.$ctrl.drivers.splice(n,1)})},t.$on("deleteDriverEvent",function(e,t){n.deleteDriver(t.id)}),t.$on("editDriverEvent",function(e,o){n.driver=o.driver,$("#photoPreview").attr("src","data:image/png;base64,"+n.driver.Photo),t.$parent.$ctrl.showAddDriverBlock()}),this.resizeBase64Img=function(e,t,n){var o=document.createElement("canvas"),r=$.Deferred();return $("<img/>").attr("src",e).load(function(){var e=this.width,i=this.height;e>i?e>t&&(i*=t/e,e=t):i>n&&(e*=n/i,i=n),o.width=e,o.height=i,o.getContext("2d").drawImage(this,0,0,e,i),r.resolve($("<img/>").attr("src",o.toDataURL()))}),r.promise()},$("#driverPhoto").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){n.resizeBase64Img(e.target.result,n.maxPhotoWidth,n.maxPhotoHeight).then(function(e){n.driver.Photo=e[0].src.replace("data:image/png;base64,",""),console.log(e[0].src),$("#photoPreview").attr("src",e[0].src)})},e.readAsDataURL(this.files[0])}})}]}),angular.module("modalBus",["core.bus"]),angular.module("modalBus").component("modalBus",{templateUrl:"Content/app/bus-list/modal/modalBus-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:function(){var e=this;e.$onInit=function(){e.bus=e.resolve.bus,e.bus&&e.bus.Id>0?e.headerTitle="Редактирование":e.headerTitle="Создание"},e.ok=function(){e.close({$value:e.bus})},e.cancel=function(){e.dismiss({$value:"cancel"})}}}),angular.module("busList",["core.bus"]),angular.module("busList").component("busList",{templateUrl:"Content/app/bus-list/bus-list.template.html",controller:["Bus","$scope","$uibModal",function(e,t,n){var o=this;o.buses=e.query(),o.bus={};var r={animation:!0,backdrop:"static",component:"modalBus",resolve:{bus:function(){return o.bus}}};o.addBus=function(){n.open(r).result.then(function(t){o.bus=t,e.add(t,function(e){o.buses.push(e),o.clearBus()})})},o.editBus=function(t){o.bus=t,n.open(r).result.then(function(t){o.bus=t,e.update({id:t.Id},t,o.clearBus)},o.clearBus)},o.deleteBus=function(t){e.delete({id:t},function(e){var t=o.buses.map(function(e){return e.Id}).indexOf(e.Id);t>-1&&o.buses.splice(t,1)})},o.clearBus=function(){o.bus={}}}]}),angular.module("agentList",["core.agent"]),angular.module("agentList").component("agentList",{templateUrl:"Content/app/agent-list/agent-list.template.html",controller:["Agent","$scope","$uibModal",function(e,t,n){var o=this;o.agents=e.query(),o.agent={};var r={animation:!0,backdrop:"static",component:"modalAgent",resolve:{agent:function(){return o.agent}}};o.addAgent=function(){n.open(r).result.then(function(t){o.agent=t,e.add(t,function(e){o.agents.push(e),o.clearAgent()})})},o.editAgent=function(t){o.agent=t,n.open(r).result.then(function(t){o.agent=t,e.update({id:t.Id},t,o.clearAgent)},o.clearAgent)},o.deleteAgent=function(t){e.delete({id:t},function(e){var t=o.agents.map(function(e){return e.Id}).indexOf(e.Id);t>-1&&o.agents.splice(t,1)},function(e){var t=e.data.Message;alert(t)})},o.clearAgent=function(){o.agent={}}}]}),angular.module("modalAgent",["core.agent"]),angular.module("modalAgent").component("modalAgent",{templateUrl:"Content/app/agent-list/modal/modalAgent-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:function(){var e=this;e.$onInit=function(){e.agent=e.resolve.agent,e.agent&&e.agent.Id>0?e.headerTitle="Редактирование":e.headerTitle="Создание"},e.ok=function(){e.close({$value:e.agent})},e.cancel=function(){e.dismiss({$value:"cancel"})}}}),angular.module("reports",[]),angular.module("reports").component("agentReports",{templateUrl:"Content/app/reports/agent-reports.template.html",controller:["Agent","AgentReport","$filter","PdfMaker",function(e,t,n,o){var r=this;r.agents=e.query(),r.agent={},r.dateTimeFormat="dd/MM/yyyy",r.dateFrom=new Date,r.dateTo=new Date,r.dateOptions={showWeeks:!1,startingDay:0,maxDate:new Date},r.reports=[],r.reportTitle="",r.totalTitle="",r.totalPrice="",r.reportIsShowing=!1,r.startDatePopup={opened:!1},r.startDateOpen=function(){r.startDatePopup.opened=!0},r.endDatePopup={opened:!1},r.endDateOpen=function(){r.endDatePopup.opened=!0},r.onGetReports=function(e){r.reports=e,r.reportTitle="Отчет по агенту "+r.agent.FullName,r.totalTitle="Итого за период с "+n("date")(r.dateFrom,"yyyy-MM-dd")+" по "+n("date")(r.dateTo,"yyyy-MM-dd")+": ",r.totalPrice=0,r.reportIsShowing=!0;for(var t=0;t<e.length;t++)r.totalPrice+=e[t].AgentCompensation},r.createReport=function(){r.reportTitle="",r.totalTitle="",r.totalPrice="";var e={id:r.agent.Id,dateFrom:n("date")(r.dateFrom,"yyyy-MM-dd"),dateTo:n("date")(r.dateTo,"yyyy-MM-dd")};t.query(e,r.onGetReports)},r.createPDF=function(e){var t=[[{text:"Дата Отправления",style:"tableHeader"},{text:"Откуда",style:"tableHeader"},{text:"Куда",style:"tableHeader"},{text:"Автобус",style:"tableHeader"},{text:"Водитель",style:"tableHeader"},{text:"Кол-во пассажиров",style:"tableHeader"},{text:"Компенсация за рейс",style:"tableHeader"}]];e.map(function(e){return t.push([e.TripDate,e.CityFrom,e.CityTo,e.BusInfo,e.DriverInfo,e.ClientsCount.toString(),e.AgentCompensation.toString()])});var i=n("date")(r.dateFrom,"yyyy-MM-dd").concat(" - ",n("date")(r.dateTo,"yyyy-MM-dd")),a={fileName:"Oтчет "+i+" "+r.agent.FullName,docDefinition:{pageOrientation:"portrait",fontSize:12,content:[{text:"Агент: "+r.agent.FullName},{text:"Oтчет за период: "+i},{text:" "},{table:{headerRows:1,body:t}},{text:" "},{text:r.totalTitle+" "+r.totalPrice}]}};o.createAndDownload(a)}}]}),angular.module("reports").component("driverReports",{templateUrl:"Content/app/reports/driver-reports.template.html",controller:["Driver","DriverReport","$filter","PdfMaker",function(e,t,n,o){var r=this;r.drivers=e.query(),r.driver={},r.dateTimeFormat="dd/MM/yyyy",r.dateFrom=new Date,r.dateTo=new Date,r.dateOptions={showWeeks:!1,startingDay:0,maxDate:new Date},r.DriverReports={},r.reportTitle="",r.totalTitle="",r.totalPrice="",r.reportIsShowing=!1,r.startDatePopup={opened:!1},r.startDateOpen=function(){r.startDatePopup.opened=!0},r.endDatePopup={opened:!1},r.endDateOpen=function(){r.endDatePopup.opened=!0},r.onGetReports=function(e){e.map(function(e){r.DriverReports[e.DriverName]?r.DriverReports[e.DriverName].push(e):r.DriverReports[e.DriverName]=[e]}),r.totalIncomes=r.getTotalIncomes(e),r.isMultipleDriversMode=Object.keys(r.DriverReports).length>1,r.reportIsShowing=!0},r.createReport=function(){r.DriverReports={},r.reportTitle="",r.totalTitle="",r.totalPrice="",r.reportIsShowing=!1;var e={id:r.driver?r.driver.Id:null,dateFrom:n("date")(r.dateFrom,"yyyy-MM-dd"),dateTo:n("date")(r.dateTo,"yyyy-MM-dd")};t.query(e,r.onGetReports)},r.getTotalIncomes=function(e){return e.reduce(function(e,t){return e+t.TotalIncomes},0)},r.getReportsPdfTable=function(e,t){var n=[{text:"Водитель: "+t}],o=[[{text:"Дата Отправления"},{text:"Откуда"},{text:"Куда"},{text:"Автобус"},{text:"Кол-во пас."},{text:"Постоянные расходы"},{text:"Непред. расходы"},{text:"Касса"},{text:"Доход"}]];return e.map(function(e){return o.push([e.TripDate,e.CityFrom,e.CityTo,e.BusInfo,e.ClientsCount?e.ClientsCount.toString():"",e.CompulsoryExpenses?e.CompulsoryExpenses.toString():"0",e.UnexpectedExpenses?e.UnexpectedExpenses.toString():"0",e.DriverCashBox?e.DriverCashBox.toString():"0",e.TotalIncomes?e.TotalIncomes.toString():"0"])}),n.push({table:{body:o}},{text:" "},{text:"Итого: "+r.getTotalIncomes(e)},{text:" "}),n},r.createPDF=function(e){function t(e){var t=r.getReportsPdfTable(r.DriverReports[e],e);a=a.concat(t)}var i=n("date")(r.dateFrom,r.dateTimeFormat).concat(" - ",n("date")(r.dateTo,r.dateTimeFormat)),a=[{text:"Oтчет за период: "+i},{text:" "}];e?t(e):Object.keys(r.DriverReports).map(function(e){return t(e)}),e||a.push({text:" "},{text:"Итого по всем водителям за период "+i+" : "+r.totalIncomes});var s=e||"по всем водителям",l={fileName:"Oтчет "+i+" "+s,docDefinition:{pageOrientation:"portrait",fontSize:12,content:a}};o.createAndDownload(l)}}]}),angular.module("clientList",["core.client"]),angular.module("clientList").component("clientList",{templateUrl:"Content/app/client-list/client-list.template.html",controller:["Client","Trip","$scope","$uibModal",function(e,t,n,o){var r=this;r.clients=e.query(),r.client={};var i={animation:!0,backdrop:"static",component:"modalClient",resolve:{client:function(){return r.client}}};r.addClient=function(){o.open(i).result.then(function(e){r.clients.push(e),r.clearClient()})},r.editClient=function(t){r.client=t,o.open(i).result.then(function(t){r.client=t,e.update({id:t.Id},t,r.clearClient)},r.clearClient)},r.deleteClient=function(t){e.delete({id:t},function(e){var t=r.clients.map(function(e){return e.Id}).indexOf(e.Id);t>-1&&r.clients.splice(t,1)})},r.clientInfo=function(e){t.query({clientId:e.Id},function(t){var n={animation:!0,backdrop:"static",component:"modalClientTrips",size:"lg",resolve:{info:function(){return{client:e,trips:t}}}};o.open(n)})},r.clearClient=function(){r.client={}}}]}),angular.module("modalClient",["core.client"]),angular.module("modalClient").component("modalClient",{templateUrl:"Content/app/client-list/modal/modalClient-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["Client",function(e){var t=this;t.message="",t.$onInit=function(){t.client=t.resolve.client,t.client&&t.client.Id>0?t.headerTitle="Редактирование":t.headerTitle="Создание"},t.ok=function(){e.add(t.client,function(e){t.close({$value:e})},function(e){var n=[];for(var o in e.data.ModelState)for(var r=0;r<e.data.ModelState[o].length;r++)n.push(e.data.ModelState[o][r]);t.message=n.join(" ")})},t.cancel=function(){t.dismiss({$value:"cancel"})}}]}),angular.module("modalClient").component("modalClientTrips",{templateUrl:"Content/app/client-list/modal/modalClientTrips-template.html",bindings:{resolve:"<",close:"&",dismiss:"&"},controller:["$filter",function(e){var t=this;t.trips={},t.client={},t.$onInit=function(){t.trips=t.resolve.info.trips,t.client=t.resolve.info.client},t.getClienPrice=function(n){return e("filter")(n,{ClientId:t.client.Id},!0)[0].Price},t.getClienAdditionalExpenses=function(n){return e("filter")(n,{ClientId:t.client.Id},!0)[0].AdditionalExpenses},t.getClientAgent=function(e){var n=e.tripClients.find(function(e){return e.ClientId==t.client.Id});e.agentName=n.AgentName},t.cancel=function(){t.dismiss({$value:"cancel"})}}]}),angular.module("citiesList",["core.city","google.places"]),angular.module("citiesList").component("citiesList",{templateUrl:"Content/app/cities-list/cities-list.template.html",controller:["City","$scope",function(e,t){var n=this;this.cities=e.query(),this.showAddCityForm=!1,this.choosedPlace="",this.showAddForm=function(){n.showAddCityForm=!n.showAddCityForm},t.autocompleteOptions={componentRestrictions:{country:"ukr"},types:["(cities)"]},this.saveCity=function(){if(n.choosedPlace){n.showAddCityForm=!1;var t=n.choosedPlace.name?n.choosedPlace.name:n.choosedPlace;e.add({name:t},function(e){n.cities.push(e),n.choosedPlace=""})}},this.removeCity=function(t){e.delete({id:t},function(e){n.cities=n.cities.filter(function(e){return e.Id!=t})})},this.setCityFromAutocomplete=function(e,t){n.city.name=t}}]}),angular.module("pdfMaker",[]),angular.module("pdfMaker").factory("PdfMaker",function(){return{createAndDownload:function(e){pdfMake.createPdf(e.docDefinition).download(e.fileName?e.fileName:"file.pdf")},createAndOpen:function(e){pdfMake.createPdf(e.docDefinition).open()}}}),angular.module("signUp",["core.authentication"]),angular.module("signUp").component("signUp",{templateUrl:"Content/app/authentication/signup/signup.template.html",controller:["AuthService","$location",function(e,t){var n=this;this.savedSuccessfully=!1,this.message="",this.registration={email:"",password:"",confirmPassword:""},this.signUp=function(o){o&&e.saveRegistration(this.registration).then(function(e){n.savedSuccessfully=!0,n.message="User has been registered successfully, you will be redirected to login page in 2 seconds.",t.path("/login")},function(e){var t=[];for(var o in e.data.ModelState)for(var r=0;r<e.data.ModelState[o].length;r++)t.push(e.data.ModelState[o][r]);n.message=t.join("\n")})}}]}),angular.module("signIn",["core.authentication"]),angular.module("signIn").component("signIn",{templateUrl:"Content/app/authentication/signin/signin.template.html",controller:["AuthService","$location",function(e,t){var n=this;e.authData.isAuth&&(e.logOut(),t.path("/login")),this.loginData={email:"",password:""},this.message="",this.login=function(){e.login(this.loginData).then(function(e){t.path("/trips")},function(e){n.message=e.data.error_description})}}]}),angular.module("navBar",["core.authentication"]),angular.module("navBar").component("navbar",{templateUrl:"Content/app/navbar/navbar.template.html",controller:["AuthService","authConstants",function(e,t){var n=this;this.ClientAccessRoles=t.ClientAccessRoles,this.BusesAccessRoles=t.BussesAccessRoles,this.updateAuthData=function(){n.isAuth=e.authData.isAuth,n.currentRole=e.authData.role},e.registerObserverCallback(n.updateAuthData),this.isAuth=e.authData.isAuth,this.currentRole=e.authData.role,this.hasRole=function(e){return!!n.isAuth&&(e?-1!=e.indexOf(n.currentRole)||"Admin"==n.currentRole:"Admin"==n.currentRole)}}]}),angular.module("VektorApp").directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,n,o){o.$validators.compareTo=function(t){return t==e.otherModelValue},e.$watch("otherModelValue",function(){o.$validate()})}}}),angular.module("manageAccount",["core.manageAccount","core.authentication"]),angular.module("manageAccount").component("manageAccount",{templateUrl:"Content/app/manage-account/manage-account.template.html",controller:["ManageAccountService","AuthService",function(e,t){var n=this;this.message="",this.updateSuccefull=null,this.accountData={},e.getAccountInfo().then(function(e){n.accountData.email=e.Email,n.accountData.name=e.Name}),this.update=function(o){o&&e.updateAccount(this.accountData).then(function(){n.message="Account has been successfully updated",n.updateSuccefull=!0,t.UpdateAuthData(n.accountData.email,n.accounData.name)},function(e){var t=[];for(var o in e.data.ModelState)for(var r=0;r<e.data.ModelState[o].length;r++)t.push(e.data.ModelState[o][r]);n.message=t.join("\n"),n.updateSuccefull=!1})}}]}),angular.module("googleMaps",[]),angular.module("googleMaps").factory("googleMapsService",[function(){var e={},t=new google.maps.DirectionsService;return e.optimizeWaypoints=function(e,n,o,r){var i=[];t.route({origin:e+", Украина",destination:n+", Украина",travelMode:google.maps.TravelMode.DRIVING,waypoints:o,optimizeWaypoints:!0},function(e){null!=e&&e.routes[0].waypoint_order.map(function(e){return i.push(o[e])}),r({response:e,waypoints:i})})},e.getGoogleMapsImage=function(t,n,o,r,i){
var a="https://maps.googleapis.com/maps/api/staticmap?size=500x400&maptype=roadmap".concat(e.covertWaypointsToUrlParams(t,n,o),"&path=color:0x0000ff80|weight:5|enc:",r,"&key=AIzaSyASESgz77PHOJYW_GWrEa4eAJPlMXeua5Q");e.convertImgToDataURL(a,i)},e.covertWaypointsToUrlParams=function(e,t,n){var o="",r=function(e,t){return"&markers=color:"+(t=t||"green")+"|"+e};return o+=r(e),n.map(function(e){return o+=r(e.location)}),o+=r(t,"red")},e.convertImgToDataURL=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){var e,n=document.createElement("CANVAS"),o=n.getContext("2d");n.height=this.height,n.width=this.width,o.drawImage(this,0,0),e=n.toDataURL(),t(e),n=null},n.src=e},e}]),angular.module("VektorApp").directive("loading",["$http","$timeout",function(e,t){return{restrict:"A",link:function(t,n,o){t.isLoading=function(){return e.pendingRequests.length>0},t.$watch(t.isLoading,function(e){e?n.show():n.hide()})}}}]);
//# sourceMappingURL=maps/all.min.js.map
